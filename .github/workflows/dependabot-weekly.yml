name: ğŸ§± LEGO Maintenance - Weekly Dependency Updates

on:
  schedule:
    # Mondays at 21:12 CET (20:12 UTC in winter, 19:12 UTC in summer)
    # Using winter time (CET = UTC+1) so 21:12 CET = 20:12 UTC
    - cron: '12 20 * * MON'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ğŸ” Check for dependency updates
  dependency-check:
    name: ğŸ” LEGO Parts Inventory Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“ Get LEGO Instructions (Checkout)
        uses: actions/checkout@v6

      - name: ğŸ§± Post Weekly Maintenance Notice
        uses: actions/github-script@v8
        with:
          script: |
            // Check if there are any open Dependabot PRs
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: 'dependabot'
            });
            
            const dependabotPRs = pulls.filter(pr => pr.user.login === 'dependabot[bot]');
            
            let message = `## ğŸ§± Weekly LEGO Maintenance Report
            
            ğŸ—“ï¸ **Weekly Dependency Check** - ${new Date().toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric', 
              month: 'long',
              day: 'numeric'
            })}
            
            ### ğŸ“¦ LEGO Parts Status:
            `;
            
            if (dependabotPRs.length === 0) {
              message += `âœ… **All LEGO pieces are up to date!**
              
              No dependency updates needed this week. All components are using the latest compatible versions.`;
            } else {
              message += `ğŸ”„ **${dependabotPRs.length} LEGO piece(s) need updating:**
              
              `;
              
              dependabotPRs.forEach(pr => {
                message += `- [${pr.title}](${pr.html_url})\\n`;
              });
              
              message += `
              
              ğŸ”§ **Action Required:** Please review and merge the Dependabot PRs above to keep our LEGO pieces compatible and secure.`;
            }
            
            message += `
            
            ### ğŸ“‹ Weekly Maintenance Checklist:
            - ğŸ” Dependencies checked
            - ğŸ›¡ï¸ Security vulnerabilities scanned  
            - ğŸ“Š Performance monitoring active
            - ğŸ§ª Automated tests passing
            
            ---
            *Automated LEGO maintenance keeps our building blocks strong! ğŸ—ï¸*`;
            
            // Create an issue for the weekly report
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ§± Weekly LEGO Maintenance Report - ${new Date().toISOString().split('T')[0]}`,
              body: message,
              labels: ['maintenance', 'weekly-report', 'dependencies']
            });

  # ğŸ›¡ï¸ Security audit
  security-audit:
    name: ğŸ›¡ï¸ LEGO Security Fortress Check  
    runs-on: ubuntu-latest
    needs: dependency-check
    
    steps:
      - name: ğŸ“ Get LEGO Instructions (Checkout)
        uses: actions/checkout@v6

      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: ğŸ” Backend Security Audit  
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit
          
          # Check for known security vulnerabilities
          export SAFETY_API_KEY="${{ secrets.SAFETY_API_KEY }}"
          safety scan || true
          
          # Static security analysis
          bandit -r . -f json -o bandit-report.json -x tests/ || true
          
      - name: ğŸ“Š Upload Security Report
        uses: actions/upload-artifact@v6
        with:
          name: security-report-backend
          path: bandit-report.json
          retention-days: 30

  # ğŸ“Š Generate maintenance summary
  maintenance-summary:
    name: ğŸ“Š LEGO Maintenance Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, security-audit]
    if: always()
    
    steps:
      - name: ğŸ¯ Create Maintenance Summary
        uses: actions/github-script@v8
        with:
          script: |
            const needs = ${{ toJson(needs) }};
            
            let summaryStatus = "âœ… All Good";
            let statusEmoji = "ğŸ›¡ï¸";
            
            // Check if any jobs failed
            const failures = Object.values(needs).filter(job => job.result === 'failure');
            
            if (failures.length > 0) {
              summaryStatus = "âš ï¸ Issues Found";
              statusEmoji = "ğŸ”§";
            }
            
            const comment = `## ${statusEmoji} Weekly LEGO Maintenance Complete
            
            **Status:** ${summaryStatus}
            
            ### ğŸ“‹ Maintenance Results:
            - ğŸ” **Dependency Check**: ${needs['dependency-check'].result === 'success' ? 'âœ… Completed' : 'âŒ Failed'}
            - ğŸ›¡ï¸ **Security Audit**: ${needs['security-audit'].result === 'success' ? 'âœ… Passed' : 'âŒ Issues Found'}
            
            ${failures.length > 0 ? 
              '### ğŸ”§ Action Required:\\nSome maintenance tasks need attention. Please check the failed jobs and resolve any issues.' :
              '### ğŸ‰ All Set!\\nYour LEGO castle is secure and up-to-date! All automated maintenance checks passed.'
            }
            
            **Next Check:** Next Monday at 21:12 CET
            
            ---
            *Weekly maintenance keeps our LEGO kingdom strong! ğŸ°*`;
            
            console.log('Maintenance summary completed:', summaryStatus);